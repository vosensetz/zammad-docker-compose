version: "3.8"

services:
  zammad-nginx:
    user: root
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        /docker-entrypoint.sh zammad-nginx &
        pid=$!
        echo "Waiting until Zammad writes real nginx config..."
        while ! grep -q "zammad-railsserver" /etc/nginx/sites-enabled/default 2>/dev/null; do
          sleep 2
        done
        echo "Config detected, applying patch..."
        sed -i 's|proxy_set_header X-Forwarded-Proto .*|proxy_set_header X-Forwarded-Proto https;|' /etc/nginx/sites-enabled/default
        sed -i 's|proxy_set_header X-Forwarded-Port .*|proxy_set_header X-Forwarded-Port 443;|' /etc/nginx/sites-enabled/default
        sed -i 's|proxy_set_header X-Forwarded-Ssl .*|proxy_set_header X-Forwarded-Ssl on;|' /etc/nginx/sites-enabled/default
        echo "Reloading nginx with patched config..."
        nginx -s reload
        wait $pid
